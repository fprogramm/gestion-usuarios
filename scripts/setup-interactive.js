const readline = require('readline');
const bcrypt = require('bcrypt');
const supabase = require('../src/config/database');

// Configurar readline para input interactivo
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

// Funci√≥n helper para hacer preguntas
function pregunta(question) {
  return new Promise((resolve) => {
    rl.question(question, resolve);
  });
}

// Validar email
function validarEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

// Validar contrase√±a
function validarPassword(password) {
  if (password.length < 8) {
    return { valid: false, message: 'La contrase√±a debe tener al menos 8 caracteres' };
  }
  if (!/[A-Z]/.test(password)) {
    return { valid: false, message: 'La contrase√±a debe tener al menos una may√∫scula' };
  }
  if (!/[a-z]/.test(password)) {
    return { valid: false, message: 'La contrase√±a debe tener al menos una min√∫scula' };
  }
  if (!/[0-9]/.test(password)) {
    return { valid: false, message: 'La contrase√±a debe tener al menos un n√∫mero' };
  }
  if (!/[!@#$%^&*]/.test(password)) {
    return { valid: false, message: 'La contrase√±a debe tener al menos un car√°cter especial (!@#$%^&*)' };
  }
  return { valid: true };
}

async function setupInteractivo() {
  try {
    console.log('\nüå± CONFIGURACI√ìN INTERACTIVA DEL SISTEMA');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('Este script te ayudar√° a crear el primer usuario administrador');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

    // 1. Verificar conexi√≥n a Supabase
    console.log('üîç Verificando conexi√≥n a Supabase...');
    const { data: testConnection, error: connectionError } = await supabase
      .from('roles')
      .select('count')
      .limit(1);

    if (connectionError) {
      console.error('‚ùå Error de conexi√≥n a Supabase:', connectionError.message);
      console.log('üí° Verifica que las variables SUPABASE_URL y SUPABASE_ANON_KEY est√©n configuradas');
      process.exit(1);
    }
    console.log('‚úÖ Conexi√≥n a Supabase exitosa\n');

    // 2. Verificar/crear roles
    console.log('üìã Verificando roles del sistema...');
    const { data: roles, error: rolesError } = await supabase
      .from('roles')
      .select('*')
      .order('id');

    if (rolesError) {
      console.error('‚ùå Error al obtener roles:', rolesError);
      process.exit(1);
    }

    if (!roles || roles.length === 0) {
      console.log('üìù No se encontraron roles. Creando roles por defecto...');
      
      const rolesDefault = [
        { nombre: 'Administrador', descripcion: 'Acceso completo al sistema' },
        { nombre: 'Editor', descripcion: 'Puede crear y editar contenido' },
        { nombre: 'Usuario', descripcion: 'Acceso b√°sico de solo lectura' },
        { nombre: 'Moderador', descripcion: 'Puede moderar contenido y usuarios' }
      ];

      const { error: insertRolesError } = await supabase
        .from('roles')
        .insert(rolesDefault);

      if (insertRolesError) {
        console.error('‚ùå Error creando roles:', insertRolesError);
        process.exit(1);
      }

      console.log('‚úÖ Roles creados correctamente');
    } else {
      console.log(`‚úÖ Encontrados ${roles.length} roles existentes`);
    }

    // 3. Mostrar roles disponibles
    const { data: rolesActualizados } = await supabase
      .from('roles')
      .select('*')
      .order('id');

    console.log('\nüõ°Ô∏è  Roles disponibles:');
    rolesActualizados.forEach((rol, index) => {
      console.log(`   ${index + 1}. ${rol.nombre} - ${rol.descripcion}`);
    });

    // 4. Recopilar informaci√≥n del usuario
    console.log('\nüë§ INFORMACI√ìN DEL USUARIO ADMINISTRADOR');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n');

    let nombre, apellido, email, password, rolSeleccionado;

    // Nombre
    do {
      nombre = await pregunta('üìù Nombre: ');
      if (!nombre.trim()) {
        console.log('‚ùå El nombre no puede estar vac√≠o');
      }
    } while (!nombre.trim());

    // Apellido
    do {
      apellido = await pregunta('üìù Apellido: ');
      if (!apellido.trim()) {
        console.log('‚ùå El apellido no puede estar vac√≠o');
      }
    } while (!apellido.trim());

    // Email
    do {
      email = await pregunta('üìß Email: ');
      if (!validarEmail(email)) {
        console.log('‚ùå Formato de email inv√°lido');
        continue;
      }

      // Verificar si el email ya existe
      const { data: emailExistente } = await supabase
        .from('usuarios')
        .select('id')
        .eq('email', email)
        .single();

      if (emailExistente) {
        console.log('‚ùå Ya existe un usuario con este email');
        email = '';
      }
    } while (!email || !validarEmail(email));

    // Contrase√±a
    do {
      password = await pregunta('üîê Contrase√±a (m√≠n. 8 caracteres, may√∫s, min√∫s, n√∫mero, especial): ');
      const validacion = validarPassword(password);
      if (!validacion.valid) {
        console.log('‚ùå', validacion.message);
        password = '';
      }
    } while (!password);

    // Rol
    do {
      const rolInput = await pregunta(`üõ°Ô∏è  Selecciona el rol (1-${rolesActualizados.length}) [1 para Administrador]: `) || '1';
      const rolIndex = parseInt(rolInput) - 1;
      
      if (rolIndex >= 0 && rolIndex < rolesActualizados.length) {
        rolSeleccionado = rolesActualizados[rolIndex];
      } else {
        console.log('‚ùå Selecci√≥n inv√°lida');
      }
    } while (!rolSeleccionado);

    // 5. Confirmar informaci√≥n
    console.log('\nüìã RESUMEN DE LA CONFIGURACI√ìN');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log(`üë§ Nombre completo: ${nombre} ${apellido}`);
    console.log(`üìß Email: ${email}`);
    console.log(`üõ°Ô∏è  Rol: ${rolSeleccionado.nombre}`);
    console.log(`üîê Contrase√±a: ${'*'.repeat(password.length)}`);
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

    const confirmacion = await pregunta('\n‚úÖ ¬øConfirmas la creaci√≥n del usuario? (s/N): ');
    
    if (confirmacion.toLowerCase() !== 's' && confirmacion.toLowerCase() !== 'si') {
      console.log('‚ùå Operaci√≥n cancelada');
      rl.close();
      return;
    }

    // 6. Crear usuario
    console.log('\nüîê Encriptando contrase√±a...');
    const passwordHash = await bcrypt.hash(password, 12);

    console.log('üë§ Creando usuario administrador...');
    const { data: nuevoUsuario, error: createError } = await supabase
      .from('usuarios')
      .insert([{
        nombre: nombre.trim(),
        apellido: apellido.trim(),
        email: email.toLowerCase().trim(),
        password_hash: passwordHash,
        rol_id: rolSeleccionado.id,
        activo: true,
        email_verificado: true
      }])
      .select(`
        *,
        roles (
          id,
          nombre,
          descripcion
        )
      `);

    if (createError) {
      console.error('‚ùå Error creando usuario:', createError);
      rl.close();
      return;
    }

    // 7. Mostrar resultado exitoso
    console.log('\nüéâ ¬°USUARIO CREADO EXITOSAMENTE!');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log(`üë§ Usuario: ${nombre} ${apellido}`);
    console.log(`üìß Email: ${email}`);
    console.log(`üõ°Ô∏è  Rol: ${rolSeleccionado.nombre}`);
    console.log(`üÜî ID: ${nuevoUsuario[0].id}`);
    console.log('‚úÖ Estado: Activo y verificado');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

    console.log('\n‚ö†Ô∏è  IMPORTANTE - GUARDA ESTA INFORMACI√ìN:');
    console.log(`üìß Email de login: ${email}`);
    console.log(`üîë Contrase√±a: ${password}`);
    console.log('\nüåê URLs de acceso:');
    console.log('   ‚Ä¢ Local: http://localhost:3000/login.html');
    console.log('   ‚Ä¢ Producci√≥n: https://tu-app.vercel.app/login.html');

    console.log('\nüí° Pr√≥ximos pasos:');
    console.log('1. Configura las variables de entorno para email en Vercel');
    console.log('2. Haz login con las credenciales creadas');
    console.log('3. Cambia la contrase√±a despu√©s del primer login');
    console.log('4. Crea otros usuarios seg√∫n sea necesario');

    // 8. Mostrar estad√≠sticas finales
    await mostrarEstadisticasFinales();

  } catch (error) {
    console.error('üí• Error inesperado:', error);
  } finally {
    rl.close();
  }
}

async function mostrarEstadisticasFinales() {
  try {
    console.log('\nüìä ESTAD√çSTICAS DEL SISTEMA');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

    const { data: usuarios } = await supabase
      .from('usuarios')
      .select(`
        *,
        roles (nombre)
      `);

    if (usuarios) {
      const stats = {};
      usuarios.forEach(usuario => {
        const rol = usuario.roles?.nombre || 'Sin rol';
        const estado = usuario.activo ? 'activos' : 'inactivos';
        
        if (!stats[rol]) {
          stats[rol] = { activos: 0, inactivos: 0, total: 0 };
        }
        
        stats[rol][estado]++;
        stats[rol].total++;
      });

      Object.entries(stats).forEach(([rol, counts]) => {
        console.log(`${rol}: ${counts.total} total (${counts.activos} activos, ${counts.inactivos} inactivos)`);
      });

      console.log(`\nTotal de usuarios: ${usuarios.length}`);
    }

    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  } catch (error) {
    console.error('Error obteniendo estad√≠sticas:', error);
  }
}

// Ejecutar si se llama directamente
if (require.main === module) {
  setupInteractivo().catch(error => {
    console.error('üí• Error fatal:', error);
    process.exit(1);
  });
}

module.exports = setupInteractivo;